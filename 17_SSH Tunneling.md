# 17_SSH Tunneling (SSH Port Forwarding)

SSH는 보안 프로토콜로 원격 호스트에 접근할 때 많이 사용한다.

SSH가 제공하는 기능 중에 `SSH Tunneling(SSH 터널링)` 혹은 `SSH Port Forwarding(SSH 포트 포워딩)`이라는 개념이 있다.

<br>

##  1. SSH Tunneling의 개념

SSH 특징상 SSH 터널링을 통해 전달되는 데이터는 모두 암호화된다.

SSH 터널링은 `프록시(Proxy)`와 비슷한 역할을 한다. 그렇다면 무엇을 위한 프록시인가? 왜 필요한가?

다음과 같이 Host A에서 Host B로 접근하려는데 방화벽(Firewall)으로 막혀있는 상황을 보자. 이럴 경우에는 Host B에 있는 서버로 직접 접근할 수 없다.

![image](https://github.com/siwon-park/Linux-Commands/assets/93081720/d5530204-ea4c-4093-acc9-ada40c584188)

바로 이럴 때 필요한 것이 SSH 터널링이다. SSH 터널링을 사용해서 방화벽을 우회하여 Host B에 있는 앱 서버로 정보를 주고 받을 수 있다. 그래서 SSH 터널링을 프록시와 비슷한 역할을 한다고 표현한 것이다.

![image](https://github.com/siwon-park/Linux-Commands/assets/93081720/ca2c2075-c95d-45d8-9812-36635714d200)

그러나 SSH 터널링이 장점만 있는 것은 아니다. 방화벽을 우회할 수 있다는 것은 방화벽을 유명무실한 것으로 만들 수 있는 것이기 때문에 공격자 입장에서 충분히 악용이 가능한 부분일 수밖에 없다.

<br>

### 1) SSH 터널링의 종류

SSH 터널링은 연결을 수립하는 주체가 누구냐에 따라서 크게 로컬 포트 포워딩과 원격 포트 포워딩으로 나뉜다. 그리고 로컬 포트 포워딩과 원격 포트 포워딩 외에 동적 포트 포워딩이라는 개념도 존재한다.

#### (1) 로컬 포트 포워딩 (Local Port Forwarding)

로컬(`SSH 클라이언트`) 시스템의 포트를 원격(`SSH 서버`) 시스템의 포트로 전달한 다음, 대상 시스템의 포트로 전달할 수 있는 형태

#### (2) 원격 포트 포워딩 (Remote Port Forwarding)

로컬 포트 포워딩의 반대 개념으로, 원격(`SSH 서버`) 시스템의 포트를 로컬(`SSH 클라이언트`) 시스템의 포트에 전달하고 대상 시스템의 포트에 전달하는 형태

#### (3) 동적 포트 포워딩 (Dynamic Port Forwarding)

로컬(`SSH 클라이언트`) 시스템에서 SOCKS 프록시 서버 역할을 하는 소켓을 만들어, 클라이언트가 이 포트에 연결하면 원격(`SSH 서버`) 시스템으로 전달되고, 원격 시스템이 대상 시스템의 동적 포트로 전달하는 형태

<br>

### 2) SSH 터널링의 장단점

#### (1) 장점

SSH 프로토콜을 기반으로 데이터를 주고 받기 때문에 보안 및 암호화, 데이터 압축 등이 자동적으로 적용된다.

또한 프록시 대신에 간단하게 사용할 수도 있다는 장점도 있다.

#### (2) 단점

방화벽을 우회하는 것이기 때문에 보안상 좋지 못한 모습이다.

또한 대용량의 데이터를 주고 받기에는 조금 부적절할 수도 있다. 경우에 따라 속도가 2배 이상 차이난다고 한다.

대용량의 데이터를 주고 받을 때는 VLAN을 사용하는 것이 보다 적절할 것이다.

<br>

## 2. 로컬 포트 포워딩 (Local Port Forwarding)

> SSH Client → SSH Server

로컬(`SSH 클라이언트`) 시스템의 포트를 원격(`SSH 서버`) 시스템의 포트로 전달한 다음, 대상 시스템의 포트로 전달할 수 있는 형태.

접근하려는 대상 서버의 방화벽의 인바운드 정책에 의해 특정 포트가 막혀있을 경우에 사용 가능하다. 만약에 외부에서 들어오는 모든 트래픽을 차단하고 있다면 로컬 포트 포워딩으로 접근하는 것은 불가능하다.

### 1) 예시

#### (1) 상황

Host A에서 Host B에서 실행 중인 Nginx 컨테이너에 접근하려는 상황. 그러나 Nginx 서버가 127.0.0.1:80에서 실행 중이어서 직접적으로 접근이 불가한 상황이다.

![image](https://github.com/siwon-park/Linux-Commands/assets/93081720/61a4a4bb-0924-4e57-8a66-01d0a5e83863)

#### (2) 해결

서로 22번 포트로 SSH 통신을 할 수 있기 때문에 SSH Client를 통해서 SSH Server로 접근하여 Host B의 Nginx 서버를 Host A의 8085번 포트로 전달한다.

![image](https://github.com/siwon-park/Linux-Commands/assets/93081720/ecb49b41-56b8-40e2-b210-fc451ed16a5a)

````bash
ssh -L [로컬 IP:로컬 Port]:[타겟 IP:타겟 Port]:[원격 호스트@원격 IP]
````

- `-L`: 로컬(Local) 포트 포워딩을 의미
- 단, 로컬 IP는 생략 시 localhost로 바인딩

<br>

## 3. 원격 포트 포워딩 (Remote Port Forwarding)

> SSH Server → SSH Client

로컬 포트 포워딩의 반대 개념으로, 원격(`SSH 서버`) 시스템의 포트를 로컬(`SSH 클라이언트`) 시스템의 포트에 전달하고 대상 시스템의 포트에 전달하는 형태

### 1) 예시

#### (1) 상황

Host A에서 Host B로 접근하려는 상황이지만, Host B의 방화벽에 의해 SSH 접근(22번 포트)을 포함한 모든 접근이 차단되고 있는 상태이다.(인바운드 트래픽 모두 차단)

단, 외부로 나가는 트래픽(아웃바운드 트래픽)은 허용하고 있는 상태일 경우에 원격 포트 포워딩을 통해 접근할 수 있다.

![image](https://github.com/siwon-park/Linux-Commands/assets/93081720/21155afc-9167-4db4-9ed9-dc47c4beecb4)

#### (2) 해결책

아웃바운드 정책은 허용 중이기 때문에 SSH Server에서 SSH Client로 연결을 수립하고 Host A의 특정 포트를 통해 SSH Client로 접근하여 SSH Server를 거쳐 Host B로 접근 가능해진다.

![image](https://github.com/siwon-park/Linux-Commands/assets/93081720/58bb6037-5af5-4527-9d58-a3516f46fc30)

```bash
ssh -R [원격 IP:원격 Port]:[타겟 IP:타겟 Port]:[소스 호스트@소스 IP]
```

- `-R`: 원격(Remote) 포트 포워딩을 의미
- ※ 정말 중요한 것!
  - 원격 포트 포워딩은 SSH Server에서 연결을 수립하는 것이기 때문에 상기 명령어는 Host B(원격)에서 입력하는 것이다.

<br>

## 4. 동적 포트 포워딩 (Dynamic Port Forwarding)

로컬(`SSH 클라이언트`) 시스템에서 SOCKS 프록시 서버 역할을 하는 소켓을 만들어, 클라이언트가 이 포트에 연결하면 원격(`SSH 서버`) 시스템으로 전달되고, 원격 시스템이 대상 시스템의 동적 포트로 전달하는 형태

### 1) 필요성

로컬 / 원격 포트 포워딩은 `1:1`로 연결 해준다.

그런데 만약 실행하기 전까지 어떤 포트로 전달해야 할지 모르거나 대상 서버의 여러 포트 중에 임의의 포트로 트래픽을 전달해야 하는 경우라면 위의 2가지 방법을 적용하기엔 조금 부적절하다.

터널링 시작 시 미리 포트를 알고 있어야 하는 로컬 / 원격 포트 포워딩에 비해, 터널링이 생성된 이후 자유롭게 포트 포워딩을 할 수 있는 방법이 동적 포트 포워딩이다.

![image](https://github.com/siwon-park/Linux-Commands/assets/93081720/2fd128aa-c29b-445d-8788-ac98b037452c)

### 2) 상황

클러스터로 서버를 구성하고 클러스터 내에 다양한 노드들을 운영 중인 경우 클러스터의 추가나 노드의 추가 생성 및 교체 등과 같은 작업이 빈번하게 발생할 때, 일일이 모든 노드의 주소와 포트를 등록하여 관리하는 것은 매우 번거롭다.

이럴 때 동적 포트 포워딩을 사용한다면 마치 프록시 서버를 통해 접근하는 것처럼 할 수 있다.

```bash
ssh -D [로컬 IP:로컬 Port] [원격 호스트@원격 IP]

# 예시
ssh -D 9090 -N -f root@172.22.1.228
```

- `-D`: 동적(Dynamic) 포트 포워딩을 의미
- 단, 로컬 IP는 생략 시 localhost로 바인딩

이후 여기서 끝나는 것이 아니라 브라우저나 응용 어플리케이션에서 SOCKS를 사용할 수 있도록 설정하는 과정이 더 필요하다.

<br>
